<html>
<head>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
<script type="text/javascript" src="https://rawgit.com/bcolpron/ff1-online/master/virtualjoystick.js"></script>
<script type="text/javascript" src="https://rawgit.com/bcolpron/ff1-online/master/tiles.js"></script>
<style>
    body {
        margin: 50px;
        width:  100%;
        height: 100%;
        overflow: hidden;
        background-color: black;
    }
    #viewport {
        background-color: blue;
        height: 480;
        width: 512;
        position: relative;
        overflow: hidden;
    }
    .character {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
    }
    #background {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
    }
</style>
<script type="text/javascript">

function Map() {
    this.sprites = $("#background");
    this.setPosition(146,158);
}

Map.prototype.setPosition = function(x,y) {
    this.position = {left:x, top:y};   
    var left = x * 32;
    var top = y * 32;
    this.sprites.each(function(i,e){
        e.style.left = -left;
        e.style.top = -top;
    });
};

function Character() {
    this.sprites = $(".character");
    this.setPosition(153,165);
}

Character.prototype.getPosition = function() {
    return {left: this.position.left, top: this.position.top};
}

Character.prototype.setPosition = function(x,y) {
    if  (typeof x === "object") {
        y = x.top;
        x = x.left;
    }

    this.position = {left:x, top:y};   
    var left = x * 32;
    var top = y * 32;
    this.sprites.each(function(i,e){
        e.style.left = left;
        e.style.top = top;
    });
};

Character.prototype.moveLeft = function() {
    this.sprites.find(".sprite").hide().eq(6).show();
};

Character.prototype.moveUp = function() {
    this.sprites.find(".sprite").hide().eq(5).show();
};

Character.prototype.moveRight = function() {
    this.sprites.find(".sprite").hide().eq(7).show();
};

Character.prototype.moveDown = function() {
    this.sprites.find(".sprite").hide().eq(4).show();
};

Character.prototype.stopMoving = function() {
    var index = this.sprites.find(".sprite:visible").index();
    this.sprites.find(".sprite").hide().eq(index & 3).show();
};

function Controller(map, character) {
    this.map = map;
    this.character = character;
    this.mask = 0;
    this.direction = this.NONE;
    this.moveTimer = null;

    var that = this;
    document.onkeyup = function(e) {
        that.onkeyup(e);
    };
    document.onkeydown = function(e) {
        that.onkeydown(e);
    };
    
    this.joystick = new VirtualJoystick({
            mouseSupport: true,
            stationaryBase: true,
            baseX: 630,
            baseY: 370,
            limitStickTravel: true,
            stickRadius: 50
        });
        
    var self = this;
    var joystickMove = false;
    function foo()
    { 
        if (self.joystick.left()) {
            self.mask = self.direction = self.LEFT;
            joystickMove = true;
        } else if (self.joystick.right()) {
            self.mask = self.direction = self.RIGHT;
            joystickMove = true;
        } else if (self.joystick.up()) {
            self.mask = self.direction = self.UP;
            joystickMove = true;
        } else if (self.joystick.down()) {
            self.mask = self.direction = self.DOWN;
            joystickMove = true;
        } else if (joystickMove) {
            self.mask = self.direction = self.NONE;
            joystickMove = false;
        }
        
        if (joystickMove && self.mask) {
            self.startMove();
        }
    }
    
    setInterval(foo, 250);
};

Controller.prototype.NONE  = 0;
Controller.prototype.UP    = 1;
Controller.prototype.DOWN  = 2;
Controller.prototype.LEFT  = 4;
Controller.prototype.RIGHT = 8;

Controller.prototype.onkeyup = function(e) {
    switch (e.keyCode) {
        case 37:
            this.mask &= 11; 
            if (this.direction == this.LEFT) this.direction = this.NONE;
            break;
        case 38:
            this.mask &= 14; 
            if (this.direction == this.UP) this.direction = this.NONE;
            break;
        case 39:
            this.mask &= 7; 
            if (this.direction == this.RIGHT) this.direction = this.NONE;
            break;
        case 40:
            this.mask &= 13; 
            if (this.direction == this.DOWN) this.direction = this.NONE;
            break;
    }
    if (this.direction == this.NONE) {
        if (this.mask & this.LEFT && ! (this.mask & this.RIGHT)) this.direction = this.LEFT;
        else if (this.mask & this.RIGHT && ! (this.mask & this.LEFT)) this.direction = this.RIGHT;
        else if (this.mask & this.UP && ! (this.mask & this.DOWN)) this.direction = this.UP;
        else if (this.mask & this.DOWN && ! (this.mask & this.UP)) this.direction = this.DOWN;
    }
};

Controller.prototype.onkeydown = function(e) {
    switch (e.keyCode) {
        case 37:
            this.mask |= this.LEFT;
            this.direction = this.LEFT;
            this.startMove();
            break;
        case 38:
            this.mask |= this.UP;
            this.direction = this.UP;
            this.startMove();
            break;
        case 39:
            this.mask |= this.RIGHT;
            this.direction = this.RIGHT;
            this.startMove();
            break;
        case 40:
            this.mask |= this.DOWN;
            this.direction = this.DOWN;
            this.startMove();
            break;
    }
};

Controller.prototype.startMove = function() {
    if (!this.moveTimer) {
        var that = this;
        this.moveTimer = setInterval(function() {
            that.move();
        }, 267);
        this.move();
    }
}
Controller.prototype.stopMove = function() {
    if (this.moveTimer) {
        clearInterval(this.moveTimer);
        this.moveTimer=null;
    }
}

Controller.prototype.move = function() {
    var p = this.character.getPosition();
    switch (this.direction) {
        case this.LEFT:
            p.left--;
            this.character.moveLeft();
            break;
        case this.UP:
            p.top--;
            this.character.moveUp();
            break;
        case this.RIGHT:
            p.left++;
            this.character.moveRight();
            break;
        case this.DOWN:
            p.top++;
            this.character.moveDown();
            break;
        case this.NONE:
            this.character.stopMoving();
            this.stopMove();
        default:
            return;
    }
    
    console.log(p.left + " " + p.top);
    if (tiles[p.left][p.top] == 0) {  // Allowed to walk
        character.setPosition(p);
    }
    else {
        this.character.stopMoving();
    }
        
    this.map.setPosition(this.character.position.left - 7, this.character.position.top - 7);
}

$(function(){
    window.character = new Character();
    window.map = new Map();
    map.setPosition(character.position.left - 7, character.position.top - 7);
    controller = new Controller(map, character); 
});

</script>
</head>
<body>
    <div id="viewport">
        <div id="background" style="left: -4672; top: -5056">
            <img src="maps/world/8x9.png" style="position: absolute; left: 4096px; top: 4320px">
            <img src="maps/world/8x10.png" style="position: absolute; left: 4096px; top: 4800px">
            <img src="maps/world/8x11.png" style="position: absolute; left: 4096px; top: 5280px">
            <img src="maps/world/8x12.png" style="position: absolute; left: 4096px; top: 5760px">

            <img src="maps/world/9x9.png" style="position: absolute; left: 4608px; top: 4320px">
            <img src="maps/world/9x10.png" style="position: absolute; left: 4608px; top: 4800px">
            <img src="maps/world/9x11.png" style="position: absolute; left: 4608px; top: 5280px">
            <img src="maps/world/9x12.png" style="position: absolute; left: 4608px; top: 5760px">
            
            <img src="maps/world/10x9.png" style="position: absolute; left: 5120px; top: 4320px">
            <img src="maps/world/10x10.png" style="position: absolute; left: 5120px; top: 4800px">
            <img src="maps/world/10x11.png" style="position: absolute; left: 5120px; top: 5280px">
            <img src="maps/world/10x12.png" style="position: absolute; left: 5120px; top: 5760px">

            <img src="maps/world/11x9.png" style="position: absolute; left: 5632px; top: 4320px">
            <img src="maps/world/11x10.png" style="position: absolute; left: 563px; top: 4800px">
            <img src="maps/world/11x11.png" style="position: absolute; left: 5632px; top: 5280px">
            <img src="maps/world/11x12.png" style="position: absolute; left: 5632px; top: 5760px">

            <div class="character">
                <img class="sprite" src="images/ww.gif" style="">
                <img class="sprite" src="images/wwup.gif" style="display: none">
                <img class="sprite" src="images/wwleft.gif" style="display: none">
                <img class="sprite" src="images/wwright.gif" style="display: none">
                <img class="sprite" src="images/wwani.gif" style="display: none">
                <img class="sprite" src="images/wwaniup.gif" style="display: none">
                <img class="sprite" src="images/wwanileft.gif" style="display: none">
                <img class="sprite" src="images/wwaniright.gif" style="display: none">
            </div>
        </div>
    </div>
</body>
</html>
