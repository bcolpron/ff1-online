<html>
<head>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.7.0/lodash.min.js"></script>
<script type="text/javascript" src="virtualjoystick.js"></script>
<script type="text/javascript" src="tiles.js"></script>
<style>
    body {
        margin: 50px;
        width:  100%;
        height: 100%;
        overflow: hidden;
        background-color: black;
    }
    #viewport {
        background-color: blue;
        height: 480;
        width: 512;
        position: relative;
        overflow: hidden;
        z-index: -1000;
    }
    .character {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
    }
    .mapArea {
        position: absolute; 
        z-index: -1;
    }
    #background {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
        z-index: -2;
    }
</style>
<script type="text/javascript">

function Map(element, x, y) {
    this.loaded = {};
    this.area = null;
    this.element = $(element)[0];
    this.setPosition(x,y);
}

Map.prototype.setPosition = function(x,y) {
    if  (typeof x === "object") {
        y = x.top;
        x = x.left;
    }
    this.position = {left:x, top:y};
    this.element.style.left = -(x * 32);
    this.element.style.top = -(y * 32);

    var newArea = {x: Math.floor(x/16), y:Math.floor(y/15)};
    if (!_.isEqual(this.area, newArea)) {
        this.area = newArea;
        this.showAreaAndAround(this.area.x, this.area.y);
    }
};

Map.prototype.showAreaAndAround = function(x,y) {
    this.show(x-1,y-1);
    this.show(x-1,y);
    this.show(x-1,y+1);
    this.show(x-1,y+2);
    this.show(x,y-1);
    this.show(x,y);
    this.show(x,y+1);
    this.show(x,y+2);
    this.show(x+1,y-1);
    this.show(x+1,y);
    this.show(x+1,y+1);
    this.show(x+1,y+2);
    this.show(x+2,y-1);
    this.show(x+2,y);
    this.show(x+2,y+1);
    this.show(x+2,y+2);
    
    // cleanup
    this.unshow(x-2, y-2);
    this.unshow(x-2, y-1);
    this.unshow(x-2, y);
    this.unshow(x-2, y+1);
    this.unshow(x-2, y+2);
    this.unshow(x-1, y-2);
    this.unshow(x-1, y+3);
    this.unshow(x, y-2);
    this.unshow(x, y+3);
    this.unshow(x+1, y-2);
    this.unshow(x+1, y+3);
    this.unshow(x+2, y-2);
    this.unshow(x+2, y+3);
    this.unshow(x+3, y-2);
    this.unshow(x+3, y-1);
    this.unshow(x+3, y);
    this.unshow(x+3, y+1);
    this.unshow(x+3, y+2);
    this.unshow(x+3, y+3);
}

Map.prototype.show = function(x,y) {
    var tag = x + "x" + y;
    if (!this.loaded[tag]) {
        console.log("loading map " + tag);
        html = '<img src="maps/world/' + tag + '.png" style="left: ' + (x*16*32) + 'px; top: ' + (y*15*32) + 'px" class="mapArea">';
        var img = this.loaded[tag] = $(html)[0];
        this.element.appendChild(img);
    }
}

Map.prototype.unshow = function(x,y) {
    var tag = x + "x" + y;
    if (this.loaded[tag]) {
        console.log("releading map " + tag);
        $(this.loaded[tag]).remove();
        delete this.loaded[tag];
    }
}

function Character(area, class_, x, y, direction) {
    this.class_ = null;
    this.sprites = $('<div class="character"/>');
    $(area).append(this.sprites);
    this.setClass(class_);
    this.setPosition(x,y);
    this.setDirection(direction || 0);
}

Character.prototype.DOWN = 0;
Character.prototype.UP       = 1;
Character.prototype.LEFT    = 2;
Character.prototype.RIGHT  = 3;
Character.prototype.ANIM    = 4;

Character.prototype.setClass = function(class_) {
    if (this.class_ === class_) {
        return;
    }
    
    if (class_ != "fi" && class_ != "bb" && class_ != "th" && class_ != "wm" && 
        class_ != "bm" && class_ != "rm" && class_ != "kn" && class_ != "ma" &&
        class_ != "ni" && class_ != "ww" && class_ != "bw" && class_ != "rw") {
         throw new Error("invalid character class");
    }
    this.class_ = class_;
    
   var html = '<img class="sprite" src="images/' + this.class_ + '.gif" style="">\
        <img class="sprite" src="images/' + this.class_ + 'up.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'left.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'right.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'ani.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'aniup.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'anileft.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'aniright.gif" style="display: none">';
                
    this.sprites.html(html);
    this.setDirection(this.direction);
 }

Character.prototype.getPosition = function() {
    return {left: this.position.left, top: this.position.top};
}

Character.prototype.setPosition = function(x,y) {
    if  (typeof x === "object") {
        y = x.top;
        x = x.left;
    }

    this.position = {left:x, top:y};   
    var left = x * 32;
    var top = y * 32;
    this.sprites.each(function(i,e){
        e.style.left = left;
        e.style.top = top;
    });
};

Character.prototype.setDirection = function(direction) {
    this.direction = direction;
    this.sprites.find(".sprite").hide().eq(direction).show();
}

Character.prototype.moveLeft = function() {
    this.setDirection(this.LEFT | this.ANIM);
};

Character.prototype.moveUp = function() {
    this.setDirection(this.UP | this.ANIM);
};

Character.prototype.moveRight = function() {
    this.setDirection(this.RIGHT | this.ANIM);
};

Character.prototype.moveDown = function() {
    this.setDirection(this.DOWN | this.ANIM);
};

Character.prototype.stopMoving = function() {
    this.setDirection(this.direction & 0x3);
};

Character.prototype.remove = function() {
    this.sprites.remove();
    this.sprites = null;
}

Character.prototype.dump = function() {
    return {left: this.position.left, top: this.position.top, direction: this.direction, class: this.class_};
}

Character.prototype.update = function(dump) {
    this.setPosition(dump.left, dump.top);
    this.setDirection(dump.direction);
    this.setClass(dump.class);
}

function Controller(map, character) {
    this.map = map;
    this.character = character;
    this.mask = 0;
    this.direction = this.NONE;
    this.moveTimer = null;

    var that = this;
    document.onkeyup = function(e) {
        that.onkeyup(e);
    };
    document.onkeydown = function(e) {
        that.onkeydown(e);
    };
    
    this.joystick = new VirtualJoystick({
            mouseSupport: true,
            stationaryBase: true,
            baseX: 630,
            baseY: 370,
            limitStickTravel: true,
            stickRadius: 50
        });
        
    var self = this;
    var joystickMove = false;
    function foo()
    { 
        if (self.joystick.left()) {
            self.mask = self.direction = self.LEFT;
            joystickMove = true;
        } else if (self.joystick.right()) {
            self.mask = self.direction = self.RIGHT;
            joystickMove = true;
        } else if (self.joystick.up()) {
            self.mask = self.direction = self.UP;
            joystickMove = true;
        } else if (self.joystick.down()) {
            self.mask = self.direction = self.DOWN;
            joystickMove = true;
        } else if (joystickMove) {
            self.mask = self.direction = self.NONE;
            joystickMove = false;
        }
        
        if (joystickMove && self.mask) {
            self.startMove();
        }
    }
    
    setInterval(foo, 250);
};

Controller.prototype.NONE  = 0;
Controller.prototype.UP    = 1;
Controller.prototype.DOWN  = 2;
Controller.prototype.LEFT  = 4;
Controller.prototype.RIGHT = 8;

Controller.prototype.onkeyup = function(e) {
    switch (e.keyCode) {
        case 37:
            this.mask &= 11; 
            if (this.direction == this.LEFT) this.direction = this.NONE;
            break;
        case 38:
            this.mask &= 14; 
            if (this.direction == this.UP) this.direction = this.NONE;
            break;
        case 39:
            this.mask &= 7; 
            if (this.direction == this.RIGHT) this.direction = this.NONE;
            break;
        case 40:
            this.mask &= 13; 
            if (this.direction == this.DOWN) this.direction = this.NONE;
            break;
    }
    if (this.direction == this.NONE) {
        if (this.mask & this.LEFT && ! (this.mask & this.RIGHT)) this.direction = this.LEFT;
        else if (this.mask & this.RIGHT && ! (this.mask & this.LEFT)) this.direction = this.RIGHT;
        else if (this.mask & this.UP && ! (this.mask & this.DOWN)) this.direction = this.UP;
        else if (this.mask & this.DOWN && ! (this.mask & this.UP)) this.direction = this.DOWN;
    }
};

Controller.prototype.onkeydown = function(e) {
    switch (e.keyCode) {
        case 37:
            this.mask |= this.LEFT;
            this.direction = this.LEFT;
            this.startMove();
            break;
        case 38:
            this.mask |= this.UP;
            this.direction = this.UP;
            this.startMove();
            break;
        case 39:
            this.mask |= this.RIGHT;
            this.direction = this.RIGHT;
            this.startMove();
            break;
        case 40:
            this.mask |= this.DOWN;
            this.direction = this.DOWN;
            this.startMove();
            break;
    }
};

Controller.prototype.startMove = function() {
    if (!this.moveTimer) {
        var that = this;
        this.moveTimer = setInterval(function() {
            that.move();
        }, 267);
        this.move();
    }
}
Controller.prototype.stopMove = function() {
    if (this.moveTimer) {
        clearInterval(this.moveTimer);
        this.moveTimer=null;
    }
}

Controller.prototype.move = function() {
    var p = this.character.getPosition();
    switch (this.direction) {
        case this.LEFT:
            p.left--;
            this.character.moveLeft();
            break;
        case this.UP:
            p.top--;
            this.character.moveUp();
            break;
        case this.RIGHT:
            p.left++;
            this.character.moveRight();
            break;
        case this.DOWN:
            p.top++;
            this.character.moveDown();
            break;
        case this.NONE:
            this.character.stopMoving();
            this.stopMove();
        default:
            return;
    }
    
    if (tiles[p.left][p.top] == 0) {  // Allowed to walk
        character.setPosition(p);
    }
    else {
        this.character.stopMoving();
    }
        
    this.map.setPosition(this.character.position.left - 7, this.character.position.top - 7);
}

$(function(){
    var area = $("#background");
    window.character = new Character(area, "fi", 153, 165);
    window.map = new Map(area, 146,158);
    map.setPosition(character.position.left - 7, character.position.top - 7);
    controller = new Controller(map, character); 
});

</script>
</head>
<body>
    <div id="viewport">
        <div id="background">
        </div>
    </div>
</body>
</html>
