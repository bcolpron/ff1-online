<html>
<head>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
<style>
    body {
        margin: 0px;
        padding: 0px;
        width:  100%;
        height: 100%;
        overflow: hidden;
    }
    #viewport {
        background-color: blue;
        height: 480;
        width: 512;
        position: relative;
        overflow: hidden;
    }
    .character {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
    }
    #background {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
    }
</style>
<script type="text/javascript">

controller = {
    NONE : 0,
    UP : 1,
    DOWN : 2,
    LEFT : 4,
    RIGHT : 8,
    direction : 0,
    mask : 0
};

document.onkeyup = function(e) {
    switch (e.keyCode) {
        case 37:
            controller.mask &= 11; 
            if (controller.direction == controller.LEFT) controller.direction = controller.NONE;
            break;
        case 38:
            controller.mask &= 14; 
            if (controller.direction == controller.UP) controller.direction = controller.NONE;
            break;
        case 39:
            controller.mask &= 7; 
            if (controller.direction == controller.RIGHT) controller.direction = controller.NONE;
            break;
        case 40:
            controller.mask &= 13; 
            if (controller.direction == controller.DOWN) controller.direction = controller.NONE;
            break;
    }
    if (controller.direction == controller.NONE) {
        if (controller.mask & controller.LEFT && ! (controller.mask & controller.RIGHT)) controller.direction = controller.LEFT;
        else if (controller.mask & controller.RIGHT && ! (controller.mask & controller.LEFT)) controller.direction = controller.RIGHT;
        else if (controller.mask & controller.UP && ! (controller.mask & controller.DOWN)) controller.direction = controller.UP;
        else if (controller.mask & controller.DOWN && ! (controller.mask & controller.UP)) controller.direction = controller.DOWN;
    }
};
document.onkeydown = function(e) {
    switch (e.keyCode) {
        case 37:
            controller.mask |= controller.LEFT;
            controller.direction = controller.LEFT;
            startMove();
            break;
        case 38:
            controller.mask |= controller.UP;
            controller.direction = controller.UP;
            startMove();
            break;
        case 39:
            controller.mask |= controller.RIGHT;
            controller.direction = controller.RIGHT;
            startMove();
            break;
        case 40:
            controller.mask |= controller.DOWN;
            controller.direction = controller.DOWN;
            startMove();
            break;
    }
};

function Character() {
    this.sprites = $(".character");
    this.setPosition(155,167);
}

Character.prototype.setPosition = function(x,y) {
    this.position = {left:x, top:y};   
    var left = x * 32;
    var top = y * 32;
    this.sprites.each(function(i,e){
        e.style.left = left;
        e.style.top = top;
    });
};

Character.prototype.moveLeft = function() {
    this.setPosition(this.position.left - 1, this.position.top);
    this.sprites.find(".sprite").hide().eq(6).show();
};

Character.prototype.moveUp = function() {
    this.setPosition(this.position.left, this.position.top - 1);
    this.sprites.find(".sprite").hide().eq(5).show();
};

Character.prototype.moveRight = function() {
    this.setPosition(this.position.left + 1, this.position.top);
    this.sprites.find(".sprite").hide().eq(7).show();
};

Character.prototype.moveDown = function() {
    this.setPosition(this.position.left, this.position.top + 1);
    this.sprites.find(".sprite").hide().eq(4).show();
};

function move(){
    var direction = controller.direction;

    switch (direction) {
        case controller.LEFT:
            var obj = document.getElementById("background");
            obj.style.left = parseInt(obj.style.left) + 32;
            character.moveLeft();
            break;
        case controller.UP:
            var obj = document.getElementById("background");
            obj.style.top = parseInt(obj.style.top) + 32;
            character.moveUp();
            break;
        case controller.RIGHT:
            var obj = document.getElementById("background");
            obj.style.left = parseInt(obj.style.left) - 32;
            character.moveRight();
            break;
        case controller.DOWN:
            var obj = document.getElementById("background");
            obj.style.top = parseInt(obj.style.top) - 32;
            character.moveDown();
            break;
        case controller.NONE:
            var sprites = $(".character");
            var index = sprites.find(".sprite:visible").index();
            sprites.find(".sprite").hide().eq(index & 3).show();
            stopMove();
    }
}

moveTimer = null;

function startMove() {
    if (!moveTimer) {
        moveTimer = setInterval(move, 267);
        move();
    }
}
function stopMove() {
    if (moveTimer) {
        clearInterval(moveTimer);
        moveTimer=null;
    }
}

$(function(){
    window.character = new Character();
});

</script>
</head>
<body>
    <div id="viewport">
        <div id="background" style="left: -4672; top: -5056">
            <img src="worldmapX2.png" >

            <div class="character">
                <img class="sprite" src="images/bb.gif" style="">
                <img class="sprite" src="images/bbup.gif" style="display: none">
                <img class="sprite" src="images/bbleft.gif" style="display: none">
                <img class="sprite" src="images/bbright.gif" style="display: none">
                <img class="sprite" src="images/bbani.gif" style="display: none">
                <img class="sprite" src="images/bbaniup.gif" style="display: none">
                <img class="sprite" src="images/bbanileft.gif" style="display: none">
                <img class="sprite" src="images/bbaniright.gif" style="display: none">
            </div>
        </div>
    </div>
</body>
</html>
