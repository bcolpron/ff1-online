<html>
<head>
<meta name="mobile-web-app-capable" content="yes">
<script type="text/javascript" src="3rd/jquery-2.2.2.min.js"></script>
<script type="text/javascript" src="3rd/lodash-4.7.0.min.js"></script>
<script type="text/javascript" src="tiles.js"></script>
<style>
    body {
        height: 100%;
        overflow: hidden;
        background-color: black;
    }
    .main-panel {
        position: relative;
        margin:auto;
        width: 832px;
        height: 448px;
        }
    #viewport {
        background-color: blue;
        height: 448px;
        width: 512;
        position: relative;
        overflow: hidden;
        z-index: -1000;
        float: left;
    }
    .character {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
        overflow: hidden;
    }
    .mapArea {
        position: absolute; 
        z-index: -1;
    }
    #background {
        position: absolute;
        transition: left 267ms, top 267ms;
        transition-timing-function: linear;
        z-index: -2;
    }
    .curtain {
        position: absolute;
        height: 50%;
        width: 100%;
        background-color: black;
        transition: height 1000ms;
        transition-timing-function: linear;
    }
    .curtain-top {
        top:0px;
    }
    .curtain-bottom {
        bottom:0px;
    }
    .joystick {
        position: absolute;
        width: 100%;
        bottom: 0px;
        margin-bottom: 30px;
    }
    .left-border {
        position: relative;
        margin-right: 10px;
        width: 150;
        background-image: url("images/title.png");
        background-repeat: no-repeat;
        height: 100%;
        float: left;
    }
    .right-border {
        position: relative;
        margin-left: 10px;
        width: 150;
        float: left;
     }
     .character-picker-button {
        width: 64px;
        height: 64px;
        padding-bottom: 10px;
        background-image: url("images/CharacterPickerButton.png");
        background-repeat: no-repeat;
    }
    .left-border img {
        display: block;
        margin: auto;
    }
    .left-border img {
        display: block;
        margin: auto;
    }
    .status {
        margin-top: 200px;
        color: gray;
        text-align: center;
    }
    .dialog-background {
        width: 100%;
        height: 100%;
        left: 0px;
        top: 0px;
        position: absolute;
        display: none;
        background-color: rgba(0, 0, 0, 0.7);
    }
    .character-picker {
        background-color: blue;
        display: none;
        position: absolute;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        margin: auto;
        width: 456px;
        height: 272px;
        border-style: solid;
        border-width: 5px;
        border-radius: 5px;
    }
    .loading-box {
        background-color: blue;
        position: absolute;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        margin: auto;
        width: 150px;
        height: 75px;
        text-align: center;
        color: white;
        border-style: solid;
        border-width: 5px;
        border-radius: 5px;
        border-color: lightgray;
    }
    .character-button {
        padding: 25px;
        padding-top: 10px;
        padding-bottom: 10px;
        float: left;
    }
    .copyright {
        text-align: center;
        margin-top: 25px;
        color: darkgray;
        font-size: xx-small;
        clear: both;
    }
    .bridge {
        position: absolute;
        left: 4864;
        top: 4864;
        z-index: 2;
    }
</style>
<script type="text/javascript">

function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

function Map(element, x, y) {
    this.loaded = {};
    this.area = null;
    this.$element = $(element);
    this.element = this.$element[0];
    this.setPosition(x,y);

    this.putShip(210, 153);
}

Map.prototype.takeShip = function() {
    this.ship.remove();
    this.ship = null;
}

Map.prototype.putShip = function(x,y) {
    this.ship = new Character(this.$element, "ship", x, y, Character.prototype.RIGHT);
}

Map.prototype.setScrollSpeed = function(speed) {
    this.$element.css({transition: "left " + 267/speed + "ms, top " + 267/speed + "ms",
                       "transition-timing-function": "linear"});
}

Map.prototype.setPosition = function(x,y) {
    if  (typeof x === "object") {
        y = x.top;
        x = x.left;
    }
    this.position = {left:x, top:y};
    this.element.style.left = -(x * 32);
    this.element.style.top = -(y * 32) - 16;

    var newArea = {x: Math.floor(x/16), y:Math.floor(y/15)};
    if (!_.isEqual(this.area, newArea)) {
        this.area = newArea;
        this.showAreaAndAround(this.area.x, this.area.y);
    }
};

Map.prototype.showAreaAndAround = function(x,y) {
    this.show(x-1,y-1);
    this.show(x-1,y);
    this.show(x-1,y+1);
    this.show(x-1,y+2);
    this.show(x,y-1);
    this.show(x,y);
    this.show(x,y+1);
    this.show(x,y+2);
    this.show(x+1,y-1);
    this.show(x+1,y);
    this.show(x+1,y+1);
    this.show(x+1,y+2);
    this.show(x+2,y-1);
    this.show(x+2,y);
    this.show(x+2,y+1);
    this.show(x+2,y+2);
    
    // cleanup
    this.unshow(x-2, y-2);
    this.unshow(x-2, y-1);
    this.unshow(x-2, y);
    this.unshow(x-2, y+1);
    this.unshow(x-2, y+2);
    this.unshow(x-1, y-2);
    this.unshow(x-1, y+3);
    this.unshow(x, y-2);
    this.unshow(x, y+3);
    this.unshow(x+1, y-2);
    this.unshow(x+1, y+3);
    this.unshow(x+2, y-2);
    this.unshow(x+2, y+3);
    this.unshow(x+3, y-2);
    this.unshow(x+3, y-1);
    this.unshow(x+3, y);
    this.unshow(x+3, y+1);
    this.unshow(x+3, y+2);
    this.unshow(x+3, y+3);
}

Map.prototype.show = function(x,y) {
    var tag = x + "x" + y;
    if (!this.loaded[tag]) {
        console.log("loading map " + tag);
        html = '<img src="maps/world/' + tag + '.png" style="left: ' + (x*16*32) + 'px; top: ' + (y*15*32) + 'px" class="mapArea">';
        var img = this.loaded[tag] = $(html)[0];
        this.element.appendChild(img);
    }
}

Map.prototype.unshow = function(x,y) {
    var tag = x + "x" + y;
    if (this.loaded[tag]) {
        console.log("releading map " + tag);
        $(this.loaded[tag]).remove();
        delete this.loaded[tag];
    }
}

function Character(area, class_, x, y, direction) {
    this.class_ = null;
    this.sprites = $('<div class="character"/>');
    $(area).append(this.sprites);
    this.setClass(class_);
    this.setPosition(x,y);
    this.setDirection(direction || 0);
}

Character.prototype.DOWN = 0;
Character.prototype.UP       = 1;
Character.prototype.LEFT    = 2;
Character.prototype.RIGHT  = 3;
Character.prototype.ANIM    = 4;
Character.prototype.classes = ["fi", "bb", "th", "wm", "bm", "rm", "kn", "ma", "ni", "ww", "bw", "rw",
                               "ship"];

Character.prototype.WALKABLE = 1;
Character.prototype.SAILABLE = 4;

Character.prototype.CHARACTER_TRAITS = {
    verticalAdjustment: -6,
    speed: 1,
    zIndex: 3,
    isMoveable(x,y) {
        return tiles[x][y] & Character.prototype.WALKABLE;
    }
};

Character.prototype.SHIP_TRAITS = {
    verticalAdjustment: -2,
    speed: 2,
    zIndex: 1,
    isMoveable(x,y) {
        return tiles[x][y] & Character.prototype.SAILABLE;
    }
};

Character.prototype.setClass = function(class_) {
    if (this.class_ === class_) {
        return;
    }
    
    if (!this.classes.find(function(e) { return e === class_; })) {
         throw new Error("invalid character class");
    }
    this.class_ = class_;
    
   var html = '<img class="sprite" src="images/' + this.class_ + '.gif" style="">\
        <img class="sprite" src="images/' + this.class_ + 'up.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'left.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'right.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'ani.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'aniup.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'anileft.gif" style="display: none">\
        <img class="sprite" src="images/' + this.class_ + 'aniright.gif" style="display: none">';
                
    this.sprites.html(html);
    this.setDirection(this.direction);

    if (Character.prototype.classes.indexOf(class_) < 12) {
        this.traits = this.CHARACTER_TRAITS;
    } else if (class_ == "ship") {
        this.traits = this.SHIP_TRAITS;
    }
    
    this.sprites.css({"z-index": this.traits.zIndex});
    this.sprites.css({transition: "left " + 267/this.traits.speed + "ms, top " + 267/this.traits.speed + "ms", "transition-timing-function": "linear"});
 }

Character.prototype.getPosition = function() {
    return {left: this.position.left, top: this.position.top};
}

Character.prototype.setPosition = function(x,y) {
    if  (typeof x === "object") {
        y = x.top;
        x = x.left;
    }

    this.position = {left:x, top:y};   
    var left = x * 32;
    var top = y * 32 + this.traits.verticalAdjustment;
    this.sprites.each(function(i,e){
        e.style.left = left;
        e.style.top = top;
    });
};

Character.prototype.setDirection = function(direction) {
    this.direction = direction;
    this.sprites.find(".sprite").hide().eq(direction).show();
}

Character.prototype.moveLeft = function() {
    this.setDirection(this.LEFT | this.ANIM);
};

Character.prototype.moveUp = function() {
    this.setDirection(this.UP | this.ANIM);
};

Character.prototype.moveRight = function() {
    this.setDirection(this.RIGHT | this.ANIM);
};

Character.prototype.moveDown = function() {
    this.setDirection(this.DOWN | this.ANIM);
};

Character.prototype.setMoving = function() {
    this.setDirection(this.direction | this.ANIM);
};

Character.prototype.stopMoving = function() {
    this.setDirection(this.direction & 0x3);
};

Character.prototype.remove = function() {
    this.sprites.remove();
    this.sprites = null;
}

Character.prototype.dump = function() {
    return {left: this.position.left, top: this.position.top, direction: this.direction, class: this.class_};
}

Character.prototype.update = function(dump) {
    this.setPosition(dump.left, dump.top);
    this.setDirection(dump.direction);
    this.setClass(dump.class);
}

Character.prototype.setTruncated = function(value) {
    this.sprites.height(value ? 16 : 32);
}

function KeyboardController(controller) {
    this.controller = controller;

    var that = this;
    document.onkeyup = function(e) {
        that.onkeyup(e);
    };
    document.onkeydown = function(e) {
        that.onkeydown(e);
    };
};

KeyboardController.prototype.UP    = 1;
KeyboardController.prototype.DOWN  = 2;
KeyboardController.prototype.LEFT  = 4;
KeyboardController.prototype.RIGHT = 8;

KeyboardController.prototype.onkeyup = function(e) {
    switch (e.keyCode) {
        case 37:
            this.mask &= 11; 
            break;
        case 38:
            this.mask &= 14; 
            break;
        case 39:
            this.mask &= 7; 
            break;
        case 40:
            this.mask &= 13; 
            break;
    }
    
    if (this.mask & this.LEFT && ! (this.mask & this.RIGHT)) this.controller.left();
    else if (this.mask & this.RIGHT && ! (this.mask & this.LEFT)) this.controller.right();
    else if (this.mask & this.UP && ! (this.mask & this.DOWN)) this.controller.up();
    else if (this.mask & this.DOWN && ! (this.mask & this.UP)) this.controller.down();
    else this.controller.stop();
};

KeyboardController.prototype.onkeydown = function(e) {
    switch (e.keyCode) {
        case 37:
            this.mask |= this.LEFT;
            this.controller.left();
            break;
        case 38:
            this.mask |= this.UP;
            this.controller.up();
            break;
        case 39:
            this.mask |= this.RIGHT;
            this.controller.right();
            break;
        case 40:
            this.mask |= this.DOWN;
            this.controller.down();
            break;
    }
};

function Controller(map, character, server, manager, classPicker) {
    this.map = map;
    this.character = character;
    this.server = server;
    this.manager = manager;
    this.classPicker = classPicker;
    this.direction = this.NONE;
    this.moveTimer = null;

    map.setPosition(character.position.left - 7, character.position.top - 7);
};

Controller.prototype.NONE  = 0;
Controller.prototype.UP    = 1;
Controller.prototype.DOWN  = 2;
Controller.prototype.LEFT  = 4;
Controller.prototype.RIGHT = 8;

Controller.prototype.DENSE_FOREST = 2;
Controller.prototype.DOCKABLE = 64;

Controller.prototype.startMove = function() {
    if (!this.moveTimer) {
        var that = this;
        this.moveTimer = setInterval(function() {
            that.move();
        }, 267/this.character.traits.speed);
        this.move();
    }
}

Controller.prototype.stopMove = function() {
    if (this.moveTimer) {
        clearInterval(this.moveTimer);
        this.moveTimer=null;
    }
}

Controller.prototype.left = function() {
    this.direction = this.LEFT;
    this.startMove();
}
Controller.prototype.right = function() {
    this.direction = this.RIGHT;
    this.startMove();
}
Controller.prototype.up = function() {
    this.direction = this.UP;
    this.startMove();
}
Controller.prototype.down = function() {
    this.direction = this.DOWN;
    this.startMove();
}
Controller.prototype.stop = function() {
    this.direction = this.NONE;
}

Controller.prototype.move = function() {
    var p = this.character.getPosition();
    switch (this.direction) {
        case this.LEFT:
            p.left--;
            this.character.moveLeft();
            break;
        case this.UP:
            p.top--;
            this.character.moveUp();
            break;
        case this.RIGHT:
            p.left++;
            this.character.moveRight();
            break;
        case this.DOWN:
            p.top++;
            this.character.moveDown();
            break;
        case this.NONE:
            this.character.stopMoving();
            this.stopMove();
        default:
            return;
    }
    
    if (character.traits.isMoveable(p.left, p.top)
        && this.manager.isFree(p.left, p.top)) {
    } else if (this.map.ship && _.isEqual(p, this.map.ship.position)) {
        this.boardShip();
        this.stopMove();
    } else if (tiles[p.left][p.top] & this.DOCKABLE) {
        this.unboardShip();
        this.stopMove();
    } else {
        p = this.character.getPosition();
        this.character.stopMoving();
    }
    
    if (tiles[p.left][p.top] & this.DENSE_FOREST) {
        var that = this;
        setTimeout(function() {that.character.setTruncated(true);}, 267/this.character.traits.speed);
    } else {
        this.character.setTruncated(false);
    }
        
    character.setPosition(p);
    this.map.setPosition(this.character.position.left - 7, this.character.position.top - 7);
    
    this.server.send(this.character.dump());
}

Controller.prototype.boardShip = function() {
    this.characterClass = this.character.class_;
    this.character.setClass("ship");
    this.character.stopMoving();
    this.map.takeShip();
    this.map.setScrollSpeed(this.character.traits.speed);
    this.classPicker.enable(false);
}

Controller.prototype.unboardShip = function() {
    this.character.setClass(this.characterClass);
    this.map.putShip(this.character.position.left, this.character.position.top);
    this.map.setScrollSpeed(this.character.traits.speed);
    this.classPicker.enable(true);
}

function Joystick(joystick, controller) {
    var moving = false;
    function move(e) {
        if (moving) {
            var offset = joystick.offset();
            var x = e.pageX - offset.left - joystick.width()/2;
            var y = e.pageY - offset.top - joystick.height()/2;
            if (Math.abs(x)>Math.abs(y)) if (x > 0) controller.right(); else controller.left();
            else if (y > 0) controller.down(); else controller.up();
        }
    }
    
    joystick.on("mousedown", function(e) {
        e.preventDefault();
        moving = true;
        move(e);
    });
    $(document).on("mouseup", function(e) {
        e.preventDefault();
        moving = false;
        controller.stop();
    });
    $(document).on("mousemove", function(e) {
        e.preventDefault();
        move(e);
    });
    joystick.on("touchstart", function(e) {
        e.preventDefault();
        moving = true;
        move(e.originalEvent.touches[0]);
    });
    $(document).on("touchend", function(e) {
        e.preventDefault();
        if (moving) {
            moving = false;
            controller.stop();
        }
    });
    $(document).on("touchmove", function(e) {
        e.preventDefault();
        if (moving) {
            move(e.originalEvent.touches[0]);
         }
    });
}

function ServerConnection(url, id, manager) {
    this.url = url;
    this.id = id;
    this.manager = manager;
    this._onConnectCallback = function() {};
    this.connect();
}

ServerConnection.prototype.connect = function() {
    this.ws = new WebSocket(this.url);
    $(".status").text("Connecting...");

    this.ws.onopen = $.proxy(this._onopen, this);
    this.ws.onclose = $.proxy(this._onclose, this);
    this.ws.onerror = function(e) {console.error("ws error: " + e);};
    this.ws.onmessage = $.proxy(this._onmessage, this);
}

ServerConnection.prototype._onopen = function() {
    console.log("Connected!")
    $(".status").text("Connected");
    this.manager.clear();
    this._onConnectCallback();
}

ServerConnection.prototype.onConnect = function(callback) {
    this._onConnectCallback = callback;
    if (this.ws.readyState === this.ws.OPEN) {
        callback();
    }
}

ServerConnection.prototype._onmessage = function(e) {
    var data = JSON.parse(e.data);
    for(var i in data.update) {
        this.manager.addOrUpdate(data.id, data.update[i]);
    }
    for(var i in data.removal) {
        this.manager.remove(data.removal[i]);
    }
}

ServerConnection.prototype.send = function(data) {
    this.ws.send(JSON.stringify({id: this.id, update: [data], removal: [] }));
}

ServerConnection.prototype._onclose = function() {
    console.log("connection closed. Reconnecting...")
    $(".status").text("Disconnected");
    var that = this;
    setTimeout(function() {
        that.connect();
    }, 1000);
}

function CharacterManager(area, player) {
    this.area = area;
    this.characters = {};
    this.playerCharacter = player;
}

CharacterManager.prototype.addOrUpdate = function(id, data) {
    var found = this.characters[id];
    if (!found) {
        found = this.characters[id] = new Character(this.area, data.class, data.left, data.top, data.direction);
    } else {
        found.update(data);
    }
    found.setMoving();
}

CharacterManager.prototype.remove = function(id) {
    var found = this.characters[id];
    if (found) {
        found.remove();
        delete this.characters[id];
    }
}

CharacterManager.prototype.clear = function() {
    for (i in this.characters) {
        this.characters[i].remove();
    }
    this.characters = {};
}

CharacterManager.prototype.isFree = function(x, y) {
    if (this.playerCharacter.position.left == x && this.playerCharacter.position.top == y) return false;

    for (i in this.characters) {
        if (this.characters[i].position.left == x && this.characters[i].position.top == y) {
            return false;
            }
    }
    return true;
}

function CharacterPicker(character, server) {

    var that = this;
    this.enabled = true;

    $(".character-picker-button").on("click touchstart", "", function(e) {
        if (that.enabled)
        {
            $(".dialog-background").show();
            $(".character-picker").show();
        }
    });
    
    $(".dialog-background").on("click touchstart", "", function() {
        $(".dialog-background").hide();
        $(".character-picker").hide();
    });
    
    $(".character-button").on("click touchstart", "", function(e) {
        $(".dialog-background").hide();
        $(".character-picker").hide();
        character.setClass($(e.target).data().class);
        server.send(character.dump());
    });
}

CharacterPicker.prototype.enable = function(val) {
    this.enabled = val;
    $(".character-picker-button").css({opacity: val ? 1 : .5});
}

function waitAllImagesLoaded(then) {
    var img$ = $("img");
    var count = img$.length;
    function imgLoaded() {
        if (--count === 0) {
            then();
        }
    }
    img$.each(function() {
        var $this = $(this);
        $this.one("load", imgLoaded);
        if (this.complete) {
            $this.trigger("load");
        }
    });
    console.log(count + " images still to load...");
}

$(function(){
    function adjust() {
        $("body").css("margin-top", ($("body").height() - $(".main-panel").height())/2);
    }
    $(window).resize(adjust);
    adjust();

    var area = $("#background");
    
    var charClass = Character.prototype.classes[Math.floor(Math.random() * 12)];
    window.character = new Character(area, charClass, 153, 165);
    
    window.map = new Map(area, 146,158);
    window.manager = new CharacterManager(area, character);
    
    var protocol = location.protocol === "https:" ? "wss" : "ws";
    window.ws = new ServerConnection(protocol + "://" + location.host + "/" + location.pathname + "/ws", guid(), manager);
    
    ws.onConnect(function() {
        ws.send(character.dump());
    });

    var picker = new CharacterPicker(character, ws);

    window.controller = new Controller(map, character, ws, manager, picker); 

    new KeyboardController(controller);
    new Joystick($(".joystick"), controller);

    waitAllImagesLoaded(function() {
        $(".loading-box").hide();
        $(".curtain").height(0);
    });
});

</script>
</head>
<body>
    <div class="main-panel">
        <div class="left-border">
            <div class="status">Not Connected</div>
            <div class="joystick">
                <img src="images/arrows.png">
            </div>
        </div>
        <div id="viewport">
            <div id="background">
                <img class="bridge" src="maps/bridge.png">
            </div>
            <div class="curtain curtain-top"></div>
            <div class="curtain curtain-bottom"></div>
        </div>
    <div class="right-border">
        <div class="character-picker-button"></div>
    </div>
    </div>
    <div class="dialog-background">
        <div class="character-picker">
            <img class="character-button" data-class="fi" src="images/fifight.gif">
            <img class="character-button" data-class="bb" src="images/bbfight.gif">
            <img class="character-button" data-class="kn" src="images/knfight.gif">
            <img class="character-button" data-class="ma" src="images/mafight.gif">
            <img class="character-button" data-class="th" src="images/thfight.gif">
            <img class="character-button" data-class="rm" src="images/rmfight.gif">
            <img class="character-button" data-class="ni" src="images/nifight.gif">
            <img class="character-button" data-class="rw" src="images/rwfight.gif">
            <img class="character-button" data-class="wm" src="images/wmfight.gif">
            <img class="character-button" data-class="bm" src="images/bmfight.gif">
            <img class="character-button" data-class="ww" src="images/wwfight.gif">
            <img class="character-button" data-class="bw" src="images/bwfight.gif">
        </div>
    </div>
    <div class="loading-box">
        <br>Loading...
    </div>
    <div class="copyright">Final Fantasy is copyright (c) SQUARE ENIX Co., Ltd.</div>
</body>
</html>
